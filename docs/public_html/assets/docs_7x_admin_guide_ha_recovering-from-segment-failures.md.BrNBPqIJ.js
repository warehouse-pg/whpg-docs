import{_ as t,c as a,o,ag as s}from"./chunks/framework.Ds6Eueu6.js";const g=JSON.parse('{"title":"Recovering from Segment Failures","description":"","frontmatter":{},"headers":[],"relativePath":"docs/7x/admin_guide/ha/recovering-from-segment-failures.md","filePath":"docs/7x/admin_guide/ha/recovering-from-segment-failures.md"}'),i={name:"docs/7x/admin_guide/ha/recovering-from-segment-failures.md"};function r(n,e,l,c,p,d){return o(),a("div",null,e[0]||(e[0]=[s(`<h1 id="recovering-from-segment-failures" tabindex="-1">Recovering from Segment Failures <a class="header-anchor" href="#recovering-from-segment-failures" aria-label="Permalink to &quot;Recovering from Segment Failures&quot;">​</a></h1><hr><p>This topic walks you through what to do when one or more segments or hosts are down and you want to recover the down segments. The recovery path you follow depends primarily which of these 3 scenarios fits your circumstances:</p><ul><li><p>you want to recover in-place to the current host</p></li><li><p>you want to recover to a different host, within the cluster</p></li><li><p>you want to recover to a new host, outside of the cluster</p></li></ul><p>The steps you follow within these scenarios can vary, depending on:</p><ul><li><p>whether you want to do an incremental or a full recovery</p></li><li><p>whether you want to recover all segments or just a subset of segments</p></li></ul><blockquote><p><strong>Note</strong> Incremental recovery is only possible when recovering segments to the current host (in-place recovery).</p></blockquote><p>This topic is divided into the following sections:</p><ul><li><a href="#prepare_for_recovery">Prerequisites</a></li><li><a href="#recovery_scenarios">Recovery Scenarios</a></li><li><a href="#post_recovery">Post-Recovery Tasks</a></li></ul><p><strong>Parent topic:</strong> <a href="./../ha/enabling-high-availability-features.html">Enabling High Availability and Data Consistency Features</a></p><h2 id="prerequisites" tabindex="-1"><a id="prepare_for_recovery"></a>Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;&lt;a id=&quot;prepare_for_recovery&quot;&gt;&lt;/a&gt;Prerequisites&quot;">​</a></h2><ul><li>Mirroring is enabled for all segments.</li><li>You&#39;ve already identified which segments have failed. If necessary, see the topic <a href="./checking-for-failed-segments.html">Checking for Failed Segments</a>.</li><li>The coordinator host can connect to the segment host.</li><li>All networking or hardware issues that caused the segment to fail have been resolved.</li></ul><h2 id="recovery-scenarios" tabindex="-1"><a id="recovery_scenarios"></a>Recovery Scenarios <a class="header-anchor" href="#recovery-scenarios" aria-label="Permalink to &quot;&lt;a id=&quot;recovery_scenarios&quot;&gt;&lt;/a&gt;Recovery Scenarios&quot;">​</a></h2><p>This section documents the steps for the 3 distinct segment recovery scenarios. Follow the link to instructions that walk you through each scenario.</p><ul><li><a href="#same_host">Recover In-Place to Current Host</a><ul><li><a href="#incremental">Incremental Recovery</a></li><li><a href="#full">Full Recovery</a></li><li><a href="#differential">Differential Recovery</a></li></ul></li><li><a href="#different_host">Recover to A Different Host within the Cluster</a></li><li><a href="#new_host">Recover to A New Host, Outside of the Cluster</a></li></ul><h3 id="recover-in-place-to-current-host" tabindex="-1"><a id="same_host"></a>Recover In-Place to Current Host <a class="header-anchor" href="#recover-in-place-to-current-host" aria-label="Permalink to &quot;&lt;a id=&quot;same_host&quot;&gt;&lt;/a&gt;Recover In-Place to Current Host&quot;">​</a></h3><p>When recovering in-place to the current host, you may choose between incremental recovery (the default), full recovery, and differential recovery.</p><h4 id="incremental-recovery" tabindex="-1"><a id="incremental"></a>Incremental Recovery <a class="header-anchor" href="#incremental-recovery" aria-label="Permalink to &quot;&lt;a id=&quot;incremental&quot;&gt;&lt;/a&gt;Incremental Recovery&quot;">​</a></h4><p>Follow these steps for incremental recovery:</p><ol><li><p>To recover all segments, run <code>gprecoverseg</code> with no options:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gprecoverseg</span></span></code></pre></div></li><li><p>To recover a subset of segments:</p><ol><li><p>Manually create a <code>recover_config_file</code> file in a location of your choice, where each segment to recover has its own line with format <code>failedAddress|failedPort|failedDataDirectory</code> or <code>failedHostname|failedAddress|failedPort|failedDataDirectory</code></p><p>For multiple segments, create a new line for each segment you want to recover, specifying the hostname (optional), the address, port number and data directory for each down segment. For example:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failedAddress1|failedPort1|failedDataDirectory1</span></span>
<span class="line"><span>failedAddress2|failedPort2|failedDataDirectory2</span></span>
<span class="line"><span>failedAddress3|failedPort3|failedDataDirectory3</span></span></code></pre></div><p>or</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failedHostname1|failedAddress1|failedPort1|failedDataDirectory1</span></span>
<span class="line"><span>failedHostname2|failedAddress2|failedPort2|failedDataDirectory2</span></span>
<span class="line"><span>failedHostname3|failedAddress3|failedPort3|failedDataDirectory3</span></span></code></pre></div></li><li><p>Alternatively, generate a sample recovery file using the following command; you may edit the resulting file if necessary:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gprecoverseg -o /home/gpadmin/recover_config_file</span></span></code></pre></div></li><li><p>Pass the <code>recover_config_file</code> to the <code>gprecoverseg -i</code> command:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gprecoverseg -i /home/gpadmin/recover_config_file</span></span></code></pre></div></li></ol></li><li><p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p></li></ol><h4 id="full-recovery" tabindex="-1"><a id="full"></a>Full Recovery <a class="header-anchor" href="#full-recovery" aria-label="Permalink to &quot;&lt;a id=&quot;full&quot;&gt;&lt;/a&gt;Full Recovery&quot;">​</a></h4><ol><li><p>To recover all segments, run <code>gprecoverseg -F</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gprecoverseg -F</span></span></code></pre></div></li><li><p>To recover specific segments:</p><ol><li><p>Manually create a <code>recover_config_file</code> file in a location of your choice, where each segment to recover has its own line with following format:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failedAddress1|failedPort1|failedDataDirectory1&lt;SPACE&gt;failedAddress2|failedPort2|failedDataDirectory2</span></span></code></pre></div><p>or</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failedHostname1|failedAddress1|failedPort1|failedDataDirectory1&lt;SPACE&gt;failedHostname2|failedAddress2|failedPort2|failedDataDirectory2</span></span></code></pre></div><p>Note the literal <strong>SPACE</strong> separating the lines.</p></li><li><p>Alternatively, generate a sample recovery file using the following command and edit the resulting file to match your desired recovery configuration:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gprecoverseg -o /home/gpadmin/recover_config_file</span></span></code></pre></div></li><li><p>Run the following command, passing in the config file generated in the previous step:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gprecoverseg -i recover_config_file</span></span></code></pre></div></li></ol></li><li><p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p></li></ol><h4 id="differential-recovery" tabindex="-1"><a id="differential"></a>Differential Recovery <a class="header-anchor" href="#differential-recovery" aria-label="Permalink to &quot;&lt;a id=&quot;differential&quot;&gt;&lt;/a&gt;Differential Recovery&quot;">​</a></h4><p>Follow these steps for differential recovery:</p><ol><li>Run <code>gprecoverseg --differential</code></li></ol><h3 id="recover-to-a-different-host-within-the-cluster" tabindex="-1"><a id="different_host"></a>Recover to A Different Host within the Cluster <a class="header-anchor" href="#recover-to-a-different-host-within-the-cluster" aria-label="Permalink to &quot;&lt;a id=&quot;different_host&quot;&gt;&lt;/a&gt;Recover to A Different Host within the Cluster&quot;">​</a></h3><blockquote><p><strong>Note</strong> Only full recovery is possible when recovering to a different host in the cluster.</p></blockquote><p>Follow these steps to recover all segments or just a subset of segments to a different host in the cluster:</p><ol><li><p>Manually create a <code>recover_config_file</code> file in a location of your choice, where each segment to recover has its own line with following format:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failedAddress|failedPort|failedDataDirectory&lt;SPACE&gt;newAddress|newPort|newDataDirectory</span></span></code></pre></div><p>or</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failedHostname|failedAddress|failedPort|failedDataDirectory&lt;SPACE&gt;newHostname|newAddress|newPort|newDataDirectory</span></span></code></pre></div><p>Note the literal <strong>SPACE</strong> separating the details of the down segment from the details of where the segment will be recovered to.</p><p>Alternatively, generate a sample recovery file using the following command and edit the resulting file to match your desired recovery configuration:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gprecoverseg -o -p /home/gpadmin/recover_config_file</span></span></code></pre></div></li><li><p>Run the following command, passing in the config file generated in the previous step:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gprecoverseg -i recover_config_file</span></span></code></pre></div></li><li><p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p></li></ol><h3 id="recover-to-a-new-host-outside-of-the-cluster" tabindex="-1"><a id="new_host"></a>Recover to A New Host, Outside of the Cluster <a class="header-anchor" href="#recover-to-a-new-host-outside-of-the-cluster" aria-label="Permalink to &quot;&lt;a id=&quot;new_host&quot;&gt;&lt;/a&gt;Recover to A New Host, Outside of the Cluster&quot;">​</a></h3><p>Follow these steps if you are planning to do a hardware refresh on the host the segments are running on.</p><blockquote><p><strong>Note</strong> Only full recovery is possible when recovering to a new host.</p></blockquote><h4 id="requirements-for-new-host" tabindex="-1"><a id="new_host_requirements"></a>Requirements for New Host <a class="header-anchor" href="#requirements-for-new-host" aria-label="Permalink to &quot;&lt;a id=&quot;new_host_requirements&quot;&gt;&lt;/a&gt;Requirements for New Host&quot;">​</a></h4><p>The new host must:</p><ul><li><p>have the same WarehousePG software installed and configured as the failed host</p></li><li><p>have the same hardware and OS configuration as the failed host (same hostname, OS version, OS configuration parameters applied, locales, gpadmin user account, data directory locations created, ssh keys exchanged, number of network interfaces, network interface naming convention, and so on)</p></li><li><p>have sufficient disk space to accommodate the segments</p></li><li><p>be able to connect password-less with all other existing segments and WarehousePG coordinator.</p></li></ul><h4 id="steps-to-recover-to-a-new-host" tabindex="-1"><a id="recover_to_new_host"></a>Steps to Recover to a New Host <a class="header-anchor" href="#steps-to-recover-to-a-new-host" aria-label="Permalink to &quot;&lt;a id=&quot;recover_to_new_host&quot;&gt;&lt;/a&gt;Steps to Recover to a New Host&quot;">​</a></h4><ol><li><p>Bring up the new host</p></li><li><p>Run the following command to recover all segments to the new host:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gprecoverseg -p &lt;new_host_name&gt;</span></span></code></pre></div><p>You may also specify more than one host. However, be sure you do not trigger a double-fault scenario when recovering to two hosts at a time.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gprecoverseg -p &lt;new_host_name1&gt;,&lt;new_host_name2&gt;</span></span></code></pre></div><blockquote><p><strong>Note</strong> In the case of multiple failed segment hosts, you can specify the hosts to recover to with a comma-separated list. However, it is strongly recommended to recover to one host at a time. If you must recover to more than one host at a time, then it is critical to ensure that a double fault scenario does not occur, in which both the segment primary and corresponding mirror are offline.</p></blockquote></li><li><p>Perform the post-recovery tasks summarized in the section <a href="#post_recovery">Post-Recovery Tasks</a>.</p></li></ol><h3 id="post-recovery-tasks" tabindex="-1"><a id="post_recovery"></a>Post-Recovery Tasks <a class="header-anchor" href="#post-recovery-tasks" aria-label="Permalink to &quot;&lt;a id=&quot;post_recovery&quot;&gt;&lt;/a&gt;Post-Recovery Tasks&quot;">​</a></h3><p>Follow these steps once <code>gprecoverseg</code> has completed:</p><ol><li><p>Validate segement status and preferred roles:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>select * from gp_segment_configuration</span></span></code></pre></div></li><li><p>Monitor mirror synchronization progress:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gpstate -e</span></span></code></pre></div></li><li><p>If necessary, run the following command to return segments to their preferred roles:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gprecoverseg -r</span></span></code></pre></div></li></ol>`,40)]))}const u=t(i,[["render",r]]);export{g as __pageData,u as default};
