import{_ as e,c as t,o as s,ag as n}from"./chunks/framework.Ds6Eueu6.js";const u=JSON.parse('{"title":"PL/Java Language","description":"","frontmatter":{},"headers":[],"relativePath":"docs/7x/analytics/pl_java.md","filePath":"docs/7x/analytics/pl_java.md"}'),i={name:"docs/7x/analytics/pl_java.md"};function o(l,a,p,c,r,d){return s(),t("div",null,a[0]||(a[0]=[n(`<h1 id="pl-java-language" tabindex="-1">PL/Java Language <a class="header-anchor" href="#pl-java-language" aria-label="Permalink to &quot;PL/Java Language&quot;">​</a></h1><hr><p>This section contains an overview of the WarehousePG PL/Java language.</p><ul><li><a href="#topic2">About PL/Java</a></li><li><a href="#topic10">About WarehousePG PL/Java</a></li><li><a href="#topic_qx1_xcp_w3b">Installing Java</a></li><li><a href="#topic4">Installing PL/Java</a></li><li><a href="#topic6">Enabling PL/Java and Installing JAR Files</a></li><li><a href="#topic7">Uninstalling PL/Java</a></li><li><a href="#topic13">Writing PL/Java functions</a></li><li><a href="#topic24">Using JDBC</a></li><li><a href="#topic25">Exception Handling</a></li><li><a href="#topic26">Savepoints</a></li><li><a href="#topic27">Logging</a></li><li><a href="#topic28">Security</a></li><li><a href="#topic33">Some PL/Java Issues and Solutions</a></li><li><a href="#topic40">Example</a></li><li><a href="#topic41">References</a></li></ul><h2 id="about-pl-java" tabindex="-1"><a id="topic2"></a>About PL/Java <a class="header-anchor" href="#about-pl-java" aria-label="Permalink to &quot;&lt;a id=&quot;topic2&quot;&gt;&lt;/a&gt;About PL/Java&quot;">​</a></h2><p>With the WarehousePG PL/Java extension, you can write Java methods using your favorite Java IDE and install the JAR files that contain those methods into WarehousePG.</p><p>WarehousePG PL/Java package is based on the open source PL/Java 1.5.0. WarehousePG PL/Java provides the following features.</p><ul><li>Ability to run PL/Java functions with Java 8, Java 11 and Java 17.</li><li>Ability to specify Java runtime.</li><li>Standardized utilities (modeled after the SQL 2003 proposal) to install and maintain Java code in the database.</li><li>Standardized mappings of parameters and result. Complex types as well as sets are supported.</li><li>An embedded, high performance, JDBC driver utilizing the internal WarehousePG SPI routines.</li><li>Metadata support for the JDBC driver. Both <code>DatabaseMetaData</code> and <code>ResultSetMetaData</code> are included.</li><li>The ability to return a ResultSet from a query as an alternative to building a ResultSet row by row.</li><li>Full support for savepoints and exception handling.</li><li>The ability to use IN, INOUT, and OUT parameters.</li><li>Two separate WarehousePG languages: <ul><li>pljava, TRUSTED PL/Java language</li><li>pljavau, UNTRUSTED PL/Java language</li></ul></li><li>Transaction and Savepoint listeners enabling code execution when a transaction or savepoint is committed or rolled back.</li><li>Integration with GNU GCJ on selected platforms.</li></ul><p>A function in SQL will appoint a static method in a Java class. In order for the function to run, the appointed class must available on the class path specified by the WarehousePG server configuration parameter <code>pljava_classpath</code>. The PL/Java extension adds a set of functions that helps installing and maintaining the java classes. Classes are stored in normal Java archives, JAR files. A JAR file can optionally contain a deployment descriptor that in turn contains SQL commands to be run when the JAR is deployed or undeployed. The functions are modeled after the standards proposed for SQL 2003.</p><p>PL/Java implements a standardized way of passing parameters and return values. Complex types and sets are passed using the standard JDBC ResultSet class.</p><p>A JDBC driver is included in PL/Java. This driver calls WarehousePG internal SPI routines. The driver is essential since it is common for functions to make calls back to the database to fetch data. When PL/Java functions fetch data, they must use the same transactional boundaries that are used by the main function that entered PL/Java execution context.</p><p>PL/Java is optimized for performance. The Java virtual machine runs within the same process as the backend to minimize call overhead. PL/Java is designed with the objective to enable the power of Java to the database itself so that database intensive business logic can run as close to the actual data as possible.</p><p>The standard Java Native Interface (JNI) is used when bridging calls between the backend and the Java VM.</p><h2 id="about-warehousepg-pl-java" tabindex="-1"><a id="topic10"></a>About WarehousePG PL/Java <a class="header-anchor" href="#about-warehousepg-pl-java" aria-label="Permalink to &quot;&lt;a id=&quot;topic10&quot;&gt;&lt;/a&gt;About WarehousePG PL/Java&quot;">​</a></h2><p>There are a few key differences between the implementation of PL/Java in standard PostgreSQL and WarehousePG.</p><h3 id="functions" tabindex="-1"><a id="topic11"></a>Functions <a class="header-anchor" href="#functions" aria-label="Permalink to &quot;&lt;a id=&quot;topic11&quot;&gt;&lt;/a&gt;Functions&quot;">​</a></h3><p>The following functions are not supported in WarehousePG. The classpath is handled differently in a distributed WarehousePG environment than in the PostgreSQL environment.</p><ul><li><code>sqlj.install_jar</code></li><li><code>sqlj.replace_jar</code></li><li><code>sqlj.remove_jar</code></li><li><code>sqlj.get_classpath</code></li><li><code>sqlj.set_classpath</code></li></ul><p>WarehousePG uses the <code>pljava_classpath</code> server configuration parameter in place of the <code>sqlj.set_classpath</code> function.</p><h3 id="server-configuration-parameters" tabindex="-1"><a id="topic12"></a>Server Configuration Parameters <a class="header-anchor" href="#server-configuration-parameters" aria-label="Permalink to &quot;&lt;a id=&quot;topic12&quot;&gt;&lt;/a&gt;Server Configuration Parameters&quot;">​</a></h3><p>The following server configuration parameters are used by PL/Java in WarehousePG. These parameters replace the <code>pljava.*</code> parameters that are used in the standard PostgreSQL PL/Java implementation:</p><ul><li><p><code>pljava_classpath</code></p><p>A colon (<code>:</code>) separated list of the jar files containing the Java classes used in any PL/Java functions. The jar files must be installed in the same locations on all WarehousePG hosts. With the trusted PL/Java language handler, jar file paths must be relative to the <code>$GPHOME/lib/postgresql/java/</code> directory. With the untrusted language handler (javaU language tag), paths may be relative to <code>$GPHOME/lib/postgresql/java/</code> or absolute.</p><p>The server configuration parameter <code>pljava_classpath_insecure</code> controls whether the server configuration parameter <code>pljava_classpath</code> can be set by a user without WarehousePG superuser privileges. When <code>pljava_classpath_insecure</code> is enabled, WarehousePG developers who are working on PL/Java functions do not have to be database superusers to change <code>pljava_classpath</code>.</p><blockquote><p><strong>Caution</strong> Enabling <code>pljava_classpath_insecure</code> exposes a security risk by giving non-administrator database users the ability to run unauthorized Java methods.</p></blockquote></li><li><p><code>pljava_statement_cache_size</code></p><p>Sets the size in KB of the Most Recently Used (MRU) cache for prepared statements.</p></li><li><p><code>pljava_release_lingering_savepoints</code></p><p>If <code>TRUE</code>, lingering savepoints will be released on function exit. If <code>FALSE</code>, they will be rolled back.</p></li><li><p><code>pljava_vmoptions</code></p><p>Defines the start up options for the WarehousePG Java VM.</p></li></ul><p>See the <em>WarehousePG Reference Guide</em> for information about the WarehousePG server configuration parameters.</p><h2 id="installing-java" tabindex="-1"><a id="topic_qx1_xcp_w3b"></a>Installing Java <a class="header-anchor" href="#installing-java" aria-label="Permalink to &quot;&lt;a id=&quot;topic_qx1_xcp_w3b&quot;&gt;&lt;/a&gt;Installing Java&quot;">​</a></h2><p>PL/Java requires a Java runtime environment on each WarehousePG host. Ensure that the same Java environment is at the same location on all hosts: coordinators and segments. The command <code>java -version</code> displays the Java version.</p><p>The commands that you use to install Java depend on the host system operating system and Java version. To install OpenJDK 8, OpenJDK 11 or OpenJDK 17 (Java 8 JDK, Java 11 JDK, Java 17 JDK) on RHEL/Oracle/Rocky Linux:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ sudo yum install java-&lt;version&gt;-openjdk-devel</span></span></code></pre></div><p>For OpenJDK 8 the version is <code>1.8.0</code>, for OpenJDK 11 the version is <code>11</code>, for OpenJDK 17 the version is <code>17</code>.</p><p>After installing OpenJDK on a RHEL system, run this <code>update-alternatives</code> command to change the default Java. Enter the number that represents the OpenJDK version to use as the default.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ sudo update-alternatives --config java</span></span></code></pre></div><blockquote><p><strong>Note</strong> When configuring host systems, you can use the <a href="./../utility_guide/ref/gpssh.html">gpssh</a> utility to run bash shell commands on multiple remote hosts.</p></blockquote><h2 id="installing-pl-java" tabindex="-1"><a id="topic4"></a>Installing PL/Java <a class="header-anchor" href="#installing-pl-java" aria-label="Permalink to &quot;&lt;a id=&quot;topic4&quot;&gt;&lt;/a&gt;Installing PL/Java&quot;">​</a></h2><p>For WarehousePG, the PL/Java extension is available as a package.</p><p>To install and use PL/Java:</p><ol><li>Specify the Java version used by PL/Java. Set the environment variables <code>JAVA_HOME</code> and <code>LD_LIBRARY_PATH</code> in the <code>greenplum_path.sh</code>.</li><li>Install the WarehousePG PL/Java extension.</li><li>Enable the language for each database where you intend to use PL/Java.</li><li>Install user-created JAR files containing Java methods into the same directory on all WarehousePG hosts.</li><li>Add the name of the JAR file to the WarehousePG server configuration parameter <code>pljava_classpath</code>. The parameter lists the installed JAR files. For information about the parameter, see the <em>WarehousePG Reference Guide</em>.</li></ol><h3 id="installing-the-warehousepg-pl-java-extension" tabindex="-1"><a id="topic5"></a>Installing the WarehousePG PL/Java Extension <a class="header-anchor" href="#installing-the-warehousepg-pl-java-extension" aria-label="Permalink to &quot;&lt;a id=&quot;topic5&quot;&gt;&lt;/a&gt;Installing the WarehousePG PL/Java Extension&quot;">​</a></h3><p>Before you install the PL/Java extension, make sure that your WarehousePG is running, you have sourced <code>greenplum_path.sh</code>, and that the <code>$COORDINATOR_DATA_DIRECTORY</code> and <code>$GPHOME</code> variables are set.</p><ol><li><p>Download the PL/Java extension package then copy it to the coordinator host.</p></li><li><p>Follow the instructions in <a href="./../install_guide/verify_sw.html">Verifying the WarehousePG Software Download</a> to verify the integrity of the <strong>WarehousePG Procedural Languages PL/Java</strong> software.</p></li><li><p>Install the software extension package</p></li><li><p>Ensure that the environment variables <code>JAVA_HOME</code> and <code>LD_LIBRARY_PATH</code> are set properly in <code>$GPHOME/greenplum_path.sh</code> on all WarehousePG hosts.</p><ul><li><p>Set the <code>JAVA_HOME</code> variable to the directory where your Java Runtime is installed. For example, for Oracle JRE this directory would be <code>/usr/java/latest</code>. For OpenJDK, the directory is <code>/usr/lib/jvm</code>. This example changes the environment variable to use <code>/usr/lib/jvm</code>.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>export JAVA_HOME=/usr/lib/jvm</span></span></code></pre></div></li><li><p>Set the <code>LD_LIBRARY_PATH</code> to include the directory with the Java server runtime libraries. PL/Java depends on <code>libjvm.so</code> and the shared object should be in your <code>LD_LIBRARY_PATH</code>. By default, <code>libjvm.so</code> is available in <code>$JAVA_HOME/lib/server</code> with JDK 11 and JDK 17, or in <code>$JAVA_HOME/jre/lib/amd64/server</code> with JDK 8. This example adds the JDK 11 directory to the environment variable.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>export LD_LIBRARY_PATH=$GPHOME/lib:$GPHOME/ext/python/lib:$JAVA_HOME/lib/server:$LD_LIBRARY_PATH</span></span></code></pre></div></li></ul><p>This example <a href="./../utility_guide/ref/gpsync.html">gpsync</a> command copies the file to all hosts specified in the file <code>gphosts_file</code>.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gpsync -f gphosts_file $GPHOME/greenplum_path.sh </span></span>
<span class="line"><span>=:$GPHOME/greenplum_path.sh</span></span></code></pre></div></li><li><p>Reload <code>greenplum_path.sh</code>.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ source $GPHOME/greenplum_path.sh</span></span></code></pre></div></li><li><p>Restart WarehousePG.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gpstop -r</span></span></code></pre></div></li></ol><h2 id="enabling-pl-java-and-installing-jar-files" tabindex="-1"><a id="topic6"></a>Enabling PL/Java and Installing JAR Files <a class="header-anchor" href="#enabling-pl-java-and-installing-jar-files" aria-label="Permalink to &quot;&lt;a id=&quot;topic6&quot;&gt;&lt;/a&gt;Enabling PL/Java and Installing JAR Files&quot;">​</a></h2><p>Perform the following steps as the WarehousePG administrator <code>gpadmin</code>.</p><ol><li><p>Enable PL/Java in a database by running the <code>CREATE EXTENSION</code> command to register the language. For example, this command enables PL/Java in the <code>testdb</code> database:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ psql -d testdb -c &#39;CREATE EXTENSION pljava;&#39;</span></span></code></pre></div><blockquote><p><strong>Note</strong> The PL/Java <code>install.sql</code> script, used in previous releases to register the language, is deprecated.</p></blockquote></li><li><p>Copy your Java archives (JAR files) to the same directory on all WarehousePG hosts. This example uses the WarehousePG <code>gpsync</code> utility to copy the file <code>myclasses.jar</code> to the directory <code>$GPHOME/lib/postgresql/java/</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gpsync -f gphosts_file myclasses.jar </span></span>
<span class="line"><span>=:/usr/local/greenplum-db/lib/postgresql/java/</span></span></code></pre></div><p>The file <code>gphosts_file</code> contains a list of the WarehousePG hosts.</p></li><li><p>Set the <code>pljava_classpath</code> server configuration parameter in the coordinator <code>postgresql.conf</code> file. For this example, the parameter value is a colon (:) separated list of the JAR files. For example:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gpconfig -c pljava_classpath -v &#39;examples.jar:myclasses.jar&#39;</span></span></code></pre></div><p>The file <code>examples.jar</code> is installed when you install the PL/Java extension package with the <code>gppkg</code> utility.</p><blockquote><p><strong>Note</strong> If you install JAR files in a directory other than <code>$GPHOME/lib/postgresql/java/</code>, you must specify the absolute path to the JAR file. Each JAR file must be in the same location on all WarehousePG hosts. For more information about specifying the location of JAR files, see the information about the <code>pljava_classpath</code> server configuration parameter in the <em>WarehousePG Reference Guide</em>.</p></blockquote></li><li><p>Reload the <code>postgresql.conf</code> file.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gpstop -u</span></span></code></pre></div></li><li><p>(optional) WarehousePG provides an <code>examples.sql</code> file containing sample PL/Java functions that you can use for testing. Run the commands in this file to create the test functions (which use the Java classes in <code>examples.jar</code>).</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ psql -f $GPHOME/share/postgresql/pljava/examples.sql</span></span></code></pre></div></li></ol><h2 id="uninstalling-pl-java" tabindex="-1"><a id="topic7"></a>Uninstalling PL/Java <a class="header-anchor" href="#uninstalling-pl-java" aria-label="Permalink to &quot;&lt;a id=&quot;topic7&quot;&gt;&lt;/a&gt;Uninstalling PL/Java&quot;">​</a></h2><ul><li><a href="#topic8">Remove PL/Java Support for a Database</a></li><li><a href="#topic_tgt_nfg_mjb">Uninstall the Java JAR files and Software Package</a></li></ul><h3 id="remove-pl-java-support-for-a-database" tabindex="-1"><a id="topic8"></a>Remove PL/Java Support for a Database <a class="header-anchor" href="#remove-pl-java-support-for-a-database" aria-label="Permalink to &quot;&lt;a id=&quot;topic8&quot;&gt;&lt;/a&gt;Remove PL/Java Support for a Database&quot;">​</a></h3><p>Use the <code>DROP EXTENSION</code> command to remove support for PL/Java from a database. For example, this command deactivates the PL/Java language in the <code>testdb</code> database:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ psql -d testdb -c &#39;DROP EXTENSION pljava;&#39;</span></span></code></pre></div><p>The default command fails if any existing objects (such as functions) depend on the language. Specify the <code>CASCADE</code> option to also drop all dependent objects, including functions that you created with PL/Java.</p><blockquote><p><strong>Note</strong> The PL/Java <code>uninstall.sql</code> script, used in previous releases to remove the language registration, is deprecated.</p></blockquote><h3 id="uninstall-the-java-jar-files-and-software-package" tabindex="-1"><a id="topic_tgt_nfg_mjb"></a>Uninstall the Java JAR files and Software Package <a class="header-anchor" href="#uninstall-the-java-jar-files-and-software-package" aria-label="Permalink to &quot;&lt;a id=&quot;topic_tgt_nfg_mjb&quot;&gt;&lt;/a&gt;Uninstall the Java JAR files and Software Package&quot;">​</a></h3><p>If no databases have PL/Java as a registered language, remove the Java JAR files and uninstall the WarehousePG PL/Java extension with the <code>gppkg</code> utility.</p><ol><li><p>Remove the <code>pljava_classpath</code> server configuration parameter from the <code>postgresql.conf</code> file on all WarehousePG hosts. For example:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gpconfig -r pljava_classpath</span></span></code></pre></div></li><li><p>Remove the JAR files from the directories where they were installed on all WarehousePG hosts. For information about JAR file installation directories, see <a href="#topic6">Enabling PL/Java and Installing JAR Files</a>.</p></li><li><p>Use the WarehousePG <code>gppkg</code> utility with the <code>remove</code> option to uninstall the PL/Java extension. This example uninstalls the PL/Java extension on a Linux system:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ gppkg remove pljava-1.4.3</span></span></code></pre></div><p>You can run the <code>gppkg</code> utility with the options <code>query</code> to list the installed extensions and their versions.</p></li><li><p>Remove any updates you made to <code>greenplum_path.sh</code> for PL/Java.</p></li><li><p>Reload <code>greenplum_path.sh</code> and restart the database</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ source $GPHOME/greenplum_path.sh</span></span>
<span class="line"><span>$ gpstop -r</span></span></code></pre></div></li></ol><h2 id="writing-pl-java-functions" tabindex="-1"><a id="topic13"></a>Writing PL/Java functions <a class="header-anchor" href="#writing-pl-java-functions" aria-label="Permalink to &quot;&lt;a id=&quot;topic13&quot;&gt;&lt;/a&gt;Writing PL/Java functions&quot;">​</a></h2><p>Information about writing functions with PL/Java.</p><ul><li><a href="#topic14">SQL Declaration</a></li><li><a href="#topic15">Type Mapping</a></li><li><a href="#topic16">NULL Handling</a></li><li><a href="#topic17">Complex Types</a></li><li><a href="#topic18">Returning Complex Types</a></li><li><a href="#topic18">Returning Complex Types</a></li><li><a href="#topic19">Functions That Return Sets</a></li><li><a href="#topic20">Returning a SETOF &lt;scalar type&gt;</a></li><li><a href="#topic21">Returning a SETOF &lt;complex type&gt;</a></li></ul><h3 id="sql-declaration" tabindex="-1"><a id="topic14"></a>SQL Declaration <a class="header-anchor" href="#sql-declaration" aria-label="Permalink to &quot;&lt;a id=&quot;topic14&quot;&gt;&lt;/a&gt;SQL Declaration&quot;">​</a></h3><p>A Java function is declared with the name of a class and a static method on that class. The class will be resolved using the classpath that has been defined for the schema where the function is declared. If no classpath has been defined for that schema, the public schema is used. If no classpath is found there either, the class is resolved using the system classloader.</p><p>The following function can be declared to access the static method <code>getProperty</code> on <code>java.lang.System</code> class:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE FUNCTION getsysprop(VARCHAR)</span></span>
<span class="line"><span>  RETURNS VARCHAR</span></span>
<span class="line"><span>  AS &#39;java.lang.System.getProperty&#39;</span></span>
<span class="line"><span>  LANGUAGE java;</span></span></code></pre></div><p>Run the following command to return the Java <code>user.home</code> property:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SELECT getsysprop(&#39;user.home&#39;);</span></span></code></pre></div><h3 id="type-mapping" tabindex="-1"><a id="topic15"></a>Type Mapping <a class="header-anchor" href="#type-mapping" aria-label="Permalink to &quot;&lt;a id=&quot;topic15&quot;&gt;&lt;/a&gt;Type Mapping&quot;">​</a></h3><p>Scalar types are mapped in a straight forward way. This table lists the current mappings.</p><table tabindex="0"><thead><tr><th>PostgreSQL</th><th>Java</th></tr></thead><tbody><tr><td>bool</td><td>boolean</td></tr><tr><td>char</td><td>byte</td></tr><tr><td>int2</td><td>short</td></tr><tr><td>int4</td><td>int</td></tr><tr><td>int8</td><td>long</td></tr><tr><td>varchar</td><td>java.lang.String</td></tr><tr><td>text</td><td>java.lang.String</td></tr><tr><td>bytea</td><td>byte[ ]</td></tr><tr><td>date</td><td>java.sql.Date</td></tr><tr><td>time</td><td>java.sql.Time (stored value treated as local time)</td></tr><tr><td>timetz</td><td>java.sql.Time</td></tr><tr><td>timestamp</td><td>java.sql.Timestamp (stored value treated as local time)</td></tr><tr><td>timestamptz</td><td>java.sql.Timestamp</td></tr><tr><td>complex</td><td>java.sql.ResultSet</td></tr><tr><td>setof complex</td><td>java.sql.ResultSet</td></tr></tbody></table><p>All other types are mapped to java.lang.String and will utilize the standard <code>textin</code>/<code>textout</code> routines registered for respective type.</p><h3 id="null-handling" tabindex="-1"><a id="topic16"></a>NULL Handling <a class="header-anchor" href="#null-handling" aria-label="Permalink to &quot;&lt;a id=&quot;topic16&quot;&gt;&lt;/a&gt;NULL Handling&quot;">​</a></h3><p>The scalar types that map to Java primitives can not be passed as <code>NULL</code> values. To pass <code>NULL</code> values, those types can have an alternative mapping. You enable this mapping by explicitly denoting it in the method reference.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE FUNCTION trueIfEvenOrNull(integer)</span></span>
<span class="line"><span>  RETURNS bool</span></span>
<span class="line"><span>  AS &#39;foo.fee.Fum.trueIfEvenOrNull(java.lang.Integer)&#39;</span></span>
<span class="line"><span>  LANGUAGE java;</span></span></code></pre></div><p>The Java code would be similar to this:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>package foo.fee;</span></span>
<span class="line"><span>public class Fum</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  static boolean trueIfEvenOrNull(Integer value)</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    return (value == null)</span></span>
<span class="line"><span>      ? true</span></span>
<span class="line"><span>      : (value.intValue() % 2) == 0;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>The following two statements both yield true:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SELECT trueIfEvenOrNull(NULL);</span></span>
<span class="line"><span>SELECT trueIfEvenOrNull(4);</span></span></code></pre></div><p>In order to return <code>NULL</code> values from a Java method, you use the object type that corresponds to the primitive (for example, you return <code>java.lang.Integer</code> instead of <code>int</code>). The PL/Java resolve mechanism finds the method regardless. Since Java cannot have different return types for methods with the same name, this does not introduce any ambiguity.</p><h3 id="complex-types" tabindex="-1"><a id="topic17"></a>Complex Types <a class="header-anchor" href="#complex-types" aria-label="Permalink to &quot;&lt;a id=&quot;topic17&quot;&gt;&lt;/a&gt;Complex Types&quot;">​</a></h3><p>A complex type will always be passed as a read-only <code>java.sql.ResultSet</code> with exactly one row. The ResultSet is positioned on its row so a call to <code>next()</code> should not be made. The values of the complex type are retrieved using the standard getter methods of the ResultSet.</p><p>Example:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE TYPE complexTest</span></span>
<span class="line"><span>  AS(base integer, incbase integer, ctime timestamptz);</span></span>
<span class="line"><span>CREATE FUNCTION useComplexTest(complexTest)</span></span>
<span class="line"><span>  RETURNS VARCHAR</span></span>
<span class="line"><span>  AS &#39;foo.fee.Fum.useComplexTest&#39;</span></span>
<span class="line"><span>  IMMUTABLE LANGUAGE java;</span></span></code></pre></div><p>In the Java class <code>Fum</code>, we add the following static method:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>public static String useComplexTest(ResultSet complexTest)</span></span>
<span class="line"><span>throws SQLException</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  int base = complexTest.getInt(1);</span></span>
<span class="line"><span>  int incbase = complexTest.getInt(2);</span></span>
<span class="line"><span>  Timestamp ctime = complexTest.getTimestamp(3);</span></span>
<span class="line"><span>  return &quot;Base = \\&quot;&quot; + base +</span></span>
<span class="line"><span>    &quot;\\&quot;, incbase = \\&quot;&quot; + incbase +</span></span>
<span class="line"><span>    &quot;\\&quot;, ctime = \\&quot;&quot; + ctime + &quot;\\&quot;&quot;;</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="returning-complex-types" tabindex="-1"><a id="topic18"></a>Returning Complex Types <a class="header-anchor" href="#returning-complex-types" aria-label="Permalink to &quot;&lt;a id=&quot;topic18&quot;&gt;&lt;/a&gt;Returning Complex Types&quot;">​</a></h3><p>Java does not stipulate any way to create a ResultSet. Hence, returning a ResultSet is not an option. The SQL-2003 draft suggests that a complex return value should be handled as an IN/OUT parameter. PL/Java implements a ResultSet that way. If you declare a function that returns a complex type, you will need to use a Java method with boolean return type with a last parameter of type <code>java.sql.ResultSet</code>. The parameter will be initialized to an empty updateable ResultSet that contains exactly one row.</p><p>Assume that the <code>complexTest</code> type in previous section has been created.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE FUNCTION createComplexTest(int, int)</span></span>
<span class="line"><span>  RETURNS complexTest</span></span>
<span class="line"><span>  AS &#39;foo.fee.Fum.createComplexTest&#39;</span></span>
<span class="line"><span>  IMMUTABLE LANGUAGE java;</span></span></code></pre></div><p>The PL/Java method resolve will now find the following method in the <code>Fum</code> class:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>public static boolean complexReturn(int base, int increment, </span></span>
<span class="line"><span>  ResultSet receiver)</span></span>
<span class="line"><span>throws SQLException</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  receiver.updateInt(1, base);</span></span>
<span class="line"><span>  receiver.updateInt(2, base + increment);</span></span>
<span class="line"><span>  receiver.updateTimestamp(3, new </span></span>
<span class="line"><span>    Timestamp(System.currentTimeMillis()));</span></span>
<span class="line"><span>  return true;</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>The return value denotes if the receiver should be considered as a valid tuple (true) or NULL (false).</p><h3 id="functions-that-return-sets" tabindex="-1"><a id="topic19"></a>Functions That Return Sets <a class="header-anchor" href="#functions-that-return-sets" aria-label="Permalink to &quot;&lt;a id=&quot;topic19&quot;&gt;&lt;/a&gt;Functions That Return Sets&quot;">​</a></h3><p>When returning result sets, you should not build a result set before returning it, because building a large result set would consume a large amount of resources. It is better to produce one row at a time. Incidentally, that is what the WarehousePG backend expects a function with SETOF return to do. You can return a SETOF a scalar type such as an <code>int</code>, <code>float</code> or <code>varchar</code>, or you can return a SETOF a complex type.</p><h3 id="returning-a-setof-scalar-type" tabindex="-1"><a id="topic20"></a>Returning a SETOF &lt;scalar type&gt; <a class="header-anchor" href="#returning-a-setof-scalar-type" aria-label="Permalink to &quot;&lt;a id=&quot;topic20&quot;&gt;&lt;/a&gt;Returning a SETOF &lt;scalar type\\&gt;&quot;">​</a></h3><p>In order to return a set of a scalar type, you need create a Java method that returns something that implements the <code>java.util.Iterator</code> interface. Here is an example of a method that returns a SETOF <code>varchar</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE FUNCTION javatest.getSystemProperties()</span></span>
<span class="line"><span>  RETURNS SETOF varchar</span></span>
<span class="line"><span>  AS &#39;foo.fee.Bar.getNames&#39;</span></span>
<span class="line"><span>  IMMUTABLE LANGUAGE java;</span></span></code></pre></div><p>This simple Java method returns an iterator:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>package foo.fee;</span></span>
<span class="line"><span>import java.util.Iterator;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public class Bar</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    public static Iterator getNames()</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        ArrayList names = new ArrayList();</span></span>
<span class="line"><span>        names.add(&quot;Lisa&quot;);</span></span>
<span class="line"><span>        names.add(&quot;Bob&quot;);</span></span>
<span class="line"><span>        names.add(&quot;Bill&quot;);</span></span>
<span class="line"><span>        names.add(&quot;Sally&quot;);</span></span>
<span class="line"><span>        return names.iterator();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="returning-a-setof-complex-type" tabindex="-1"><a id="topic21"></a>Returning a SETOF &lt;complex type&gt; <a class="header-anchor" href="#returning-a-setof-complex-type" aria-label="Permalink to &quot;&lt;a id=&quot;topic21&quot;&gt;&lt;/a&gt;Returning a SETOF &lt;complex type\\&gt;&quot;">​</a></h3><p>A method returning a SETOF &lt;complex type&gt; must use either the interface <code>org.postgresql.pljava.ResultSetProvider</code> or <code>org.postgresql.pljava.ResultSetHandle</code>. The reason for having two interfaces is that they cater for optimal handling of two distinct use cases. The former is for cases when you want to dynamically create each row that is to be returned from the SETOF function. The latter makes sense in cases where you want to return the result of a query after it runs.</p><h4 id="using-the-resultsetprovider-interface" tabindex="-1"><a id="topic22"></a>Using the ResultSetProvider Interface <a class="header-anchor" href="#using-the-resultsetprovider-interface" aria-label="Permalink to &quot;&lt;a id=&quot;topic22&quot;&gt;&lt;/a&gt;Using the ResultSetProvider Interface&quot;">​</a></h4><p>This interface has two methods. The boolean <code>assignRowValues(java.sql.ResultSet tupleBuilder, int rowNumber)</code> and the <code>void close()</code> method. The WarehousePG query evaluator will call the <code>assignRowValues</code> repeatedly until it returns false or until the evaluator decides that it does not need any more rows. Then it calls close.</p><p>You can use this interface the following way:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE FUNCTION javatest.listComplexTests(int, int)</span></span>
<span class="line"><span>  RETURNS SETOF complexTest</span></span>
<span class="line"><span>  AS &#39;foo.fee.Fum.listComplexTest&#39;</span></span>
<span class="line"><span>  IMMUTABLE LANGUAGE java;</span></span></code></pre></div><p>The function maps to a static java method that returns an instance that implements the <code>ResultSetProvider</code> interface.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>public class Fum implements ResultSetProvider</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  private final int m_base;</span></span>
<span class="line"><span>  private final int m_increment;</span></span>
<span class="line"><span>  public Fum(int base, int increment)</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    m_base = base;</span></span>
<span class="line"><span>    m_increment = increment;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  public boolean assignRowValues(ResultSet receiver, int </span></span>
<span class="line"><span>currentRow)</span></span>
<span class="line"><span>  throws SQLException</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    // Stop when we reach 12 rows.</span></span>
<span class="line"><span>    //</span></span>
<span class="line"><span>    if(currentRow &gt;= 12)</span></span>
<span class="line"><span>      return false;</span></span>
<span class="line"><span>    receiver.updateInt(1, m_base);</span></span>
<span class="line"><span>    receiver.updateInt(2, m_base + m_increment * currentRow);</span></span>
<span class="line"><span>    receiver.updateTimestamp(3, new </span></span>
<span class="line"><span>Timestamp(System.currentTimeMillis()));</span></span>
<span class="line"><span>    return true;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  public void close()</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>   // Nothing needed in this example</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  public static ResultSetProvider listComplexTests(int base, </span></span>
<span class="line"><span>int increment)</span></span>
<span class="line"><span>  throws SQLException</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    return new Fum(base, increment);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>The <code>listComplextTests</code> method is called once. It may return <code>NULL</code> if no results are available or an instance of the <code>ResultSetProvider</code>. Here the Java class <code>Fum</code> implements this interface so it returns an instance of itself. The method <code>assignRowValues</code> will then be called repeatedly until it returns false. At that time, close will be called.</p><h4 id="using-the-resultsethandle-interface" tabindex="-1"><a id="topic23"></a>Using the ResultSetHandle Interface <a class="header-anchor" href="#using-the-resultsethandle-interface" aria-label="Permalink to &quot;&lt;a id=&quot;topic23&quot;&gt;&lt;/a&gt;Using the ResultSetHandle Interface&quot;">​</a></h4><p>This interface is similar to the <code>ResultSetProvider</code> interface in that it has a <code>close()</code> method that will be called at the end. But instead of having the evaluator call a method that builds one row at a time, this method has a method that returns a ResultSet. The query evaluator will iterate over this set and deliver the RestulSet contents, one tuple at a time, to the caller until a call to <code>next()</code> returns false or the evaluator decides that no more rows are needed.</p><p>Here is an example that runs a query using a statement that it obtained using the default connection. The SQL suitable for the deployment descriptor looks like this:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE FUNCTION javatest.listSupers()</span></span>
<span class="line"><span>  RETURNS SETOF pg_user</span></span>
<span class="line"><span>  AS &#39;org.postgresql.pljava.example.Users.listSupers&#39;</span></span>
<span class="line"><span>  LANGUAGE java;</span></span>
<span class="line"><span>CREATE FUNCTION javatest.listNonSupers()</span></span>
<span class="line"><span>  RETURNS SETOF pg_user</span></span>
<span class="line"><span>  AS &#39;org.postgresql.pljava.example.Users.listNonSupers&#39;</span></span>
<span class="line"><span>  LANGUAGE java;</span></span></code></pre></div><p>And in the Java package <code>org.postgresql.pljava.example</code> a class <code>Users</code> is added:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>public class Users implements ResultSetHandle</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  private final String m_filter;</span></span>
<span class="line"><span>  private Statement m_statement;</span></span>
<span class="line"><span>  public Users(String filter)</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    m_filter = filter;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  public ResultSet getResultSet()</span></span>
<span class="line"><span>  throws SQLException</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    m_statement = </span></span>
<span class="line"><span>      DriverManager.getConnection(&quot;jdbc:default:connection&quot;).cr</span></span>
<span class="line"><span>eateStatement();</span></span>
<span class="line"><span>    return m_statement.executeQuery(&quot;SELECT * FROM pg_user </span></span>
<span class="line"><span>       WHERE &quot; + m_filter);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  public void close()</span></span>
<span class="line"><span>  throws SQLException</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    m_statement.close();</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  public static ResultSetHandle listSupers()</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    return new Users(&quot;usesuper = true&quot;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  public static ResultSetHandle listNonSupers()</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    return new Users(&quot;usesuper = false&quot;);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="using-jdbc" tabindex="-1"><a id="topic24"></a>Using JDBC <a class="header-anchor" href="#using-jdbc" aria-label="Permalink to &quot;&lt;a id=&quot;topic24&quot;&gt;&lt;/a&gt;Using JDBC&quot;">​</a></h2><p>PL/Java contains a JDBC driver that maps to the PostgreSQL SPI functions. A connection that maps to the current transaction can be obtained using the following statement:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Connection conn = </span></span>
<span class="line"><span>  DriverManager.getConnection(&quot;jdbc:default:connection&quot;);</span></span></code></pre></div><p>After obtaining a connection, you can prepare and run statements similar to other JDBC connections. These are limitations for the PL/Java JDBC driver:</p><ul><li>The transaction cannot be managed in any way. Thus, you cannot use methods on the connection such as: <ul><li><code>commit()</code></li><li><code>rollback()</code></li><li><code>setAutoCommit()</code></li><li><code>setTransactionIsolation()</code></li></ul></li><li>Savepoints are available with some restrictions. A savepoint cannot outlive the function in which it was set and it must be rolled back or released by that same function.</li><li>A ResultSet returned from <code>executeQuery()</code> are always <code>FETCH_FORWARD</code> and <code>CONCUR_READ_ONLY</code>.</li><li>Metadata is only available in PL/Java 1.1 or higher.</li><li><code>CallableStatement</code> (for stored procedures) is not implemented.</li><li>The types <code>Clob</code> or <code>Blob</code> are not completely implemented, they need more work. The types <code>byte[]</code> and <code>String</code> can be used for <code>bytea</code> and <code>text</code> respectively.</li></ul><h2 id="exception-handling" tabindex="-1"><a id="topic25"></a>Exception Handling <a class="header-anchor" href="#exception-handling" aria-label="Permalink to &quot;&lt;a id=&quot;topic25&quot;&gt;&lt;/a&gt;Exception Handling&quot;">​</a></h2><p>You can catch and handle an exception in the WarehousePG backend just like any other exception. The backend ErrorData structure is exposed as a property in a class called <code>org.postgresql.pljava.ServerException</code> (derived from <code>java.sql.SQLException</code>) and the Java try/catch mechanism is synchronized with the backend mechanism.</p><blockquote><p><strong>Important</strong> You will not be able to continue running backend functions until your function has returned and the error has been propagated when the backend has generated an exception unless you have used a savepoint. When a savepoint is rolled back, the exceptional condition is reset and you can continue your execution.</p></blockquote><h2 id="savepoints" tabindex="-1"><a id="topic26"></a>Savepoints <a class="header-anchor" href="#savepoints" aria-label="Permalink to &quot;&lt;a id=&quot;topic26&quot;&gt;&lt;/a&gt;Savepoints&quot;">​</a></h2><p>WarehousePG savepoints are exposed using the java.sql.Connection interface. Two restrictions apply.</p><ul><li>A savepoint must be rolled back or released in the function where it was set.</li><li>A savepoint must not outlive the function where it was set.</li></ul><h2 id="logging" tabindex="-1"><a id="topic27"></a>Logging <a class="header-anchor" href="#logging" aria-label="Permalink to &quot;&lt;a id=&quot;topic27&quot;&gt;&lt;/a&gt;Logging&quot;">​</a></h2><p>PL/Java uses the standard Java Logger. Hence, you can write things like:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Logger.getAnonymousLogger().info( &quot;Time is &quot; + new </span></span>
<span class="line"><span>Date(System.currentTimeMillis()));</span></span></code></pre></div><p>At present, the logger uses a handler that maps the current state of the WarehousePG configuration setting <code>log_min_messages</code> to a valid Logger level and that outputs all messages using the WarehousePG backend function <code>elog()</code>.</p><blockquote><p><strong>Note</strong> The <code>log_min_messages</code> setting is read from the database the first time a PL/Java function in a session is run. On the Java side, the setting does not change after the first PL/Java function execution in a specific session until the WarehousePG session that is working with PL/Java is restarted.</p></blockquote><p>The following mapping apply between the Logger levels and the WarehousePG backend levels.</p><table tabindex="0"><thead><tr><th>java.util.logging.Level</th><th>WarehousePG Level</th></tr></thead><tbody><tr><td>SEVERE ERROR</td><td>ERROR</td></tr><tr><td>WARNING</td><td>WARNING</td></tr><tr><td>CONFIG</td><td>LOG</td></tr><tr><td>INFO</td><td>INFO</td></tr><tr><td>FINE</td><td>DEBUG1</td></tr><tr><td>FINER</td><td>DEBUG2</td></tr><tr><td>FINEST</td><td>DEBUG3</td></tr></tbody></table><h2 id="security" tabindex="-1"><a id="topic28"></a>Security <a class="header-anchor" href="#security" aria-label="Permalink to &quot;&lt;a id=&quot;topic28&quot;&gt;&lt;/a&gt;Security&quot;">​</a></h2><ul><li><a href="#topic29">Installation</a></li><li><a href="#topic30">Trusted Language</a></li></ul><h3 id="installation" tabindex="-1"><a id="topic29"></a>Installation <a class="header-anchor" href="#installation" aria-label="Permalink to &quot;&lt;a id=&quot;topic29&quot;&gt;&lt;/a&gt;Installation&quot;">​</a></h3><p>Only a database superuser can install PL/Java. The PL/Java utility functions are installed using SECURITY DEFINER so that they run with the access permissions that were granted to the creator of the functions.</p><h3 id="trusted-language" tabindex="-1"><a id="topic30"></a>Trusted Language <a class="header-anchor" href="#trusted-language" aria-label="Permalink to &quot;&lt;a id=&quot;topic30&quot;&gt;&lt;/a&gt;Trusted Language&quot;">​</a></h3><p>PL/Java is a <em>trusted</em> language. The trusted PL/Java language has no access to the file system as stipulated by PostgreSQL definition of a trusted language. Any database user can create and access functions in a trusted language.</p><p>PL/Java also installs a language handler for the language <code>javau</code>. This version is <em>not trusted</em> and only a superuser can create new functions that use it. Any user can call the functions.</p><p>To install both the trusted and untrusted languages, register the extension by running the <code>&#39;CREATE EXTENSION pljava&#39;</code> command when <a href="#topic6">Enabling PL/Java and Installing JAR Files</a>.</p><p>To install only the trusted language, register the extension by running the <code>&#39;CREATE EXTENSION pljavat&#39;</code> command when <a href="#topic6">Enabling PL/Java and Installing JAR Files</a>.</p><h2 id="some-pl-java-issues-and-solutions" tabindex="-1"><a id="topic33"></a>Some PL/Java Issues and Solutions <a class="header-anchor" href="#some-pl-java-issues-and-solutions" aria-label="Permalink to &quot;&lt;a id=&quot;topic33&quot;&gt;&lt;/a&gt;Some PL/Java Issues and Solutions&quot;">​</a></h2><p>When writing the PL/Java, mapping the JVM into the same process-space as the WarehousePG backend code, some concerns have been raised regarding multiple threads, exception handling, and memory management. Here are brief descriptions explaining how these issues where resolved.</p><ul><li><a href="#topic34">Multi-threading</a></li><li><a href="#topic36">Exception Handling</a></li><li><a href="#topic38">Java Garbage Collector Versus palloc() and Stack Allocation</a></li></ul><h3 id="multi-threading" tabindex="-1"><a id="topic34"></a>Multi-threading <a class="header-anchor" href="#multi-threading" aria-label="Permalink to &quot;&lt;a id=&quot;topic34&quot;&gt;&lt;/a&gt;Multi-threading&quot;">​</a></h3><p>Java is inherently multi-threaded. The WarehousePG backend is not. There is nothing stopping a developer from utilizing multiple Threads class in the Java code. Finalizers that call out to the backend might have been spawned from a background Garbage Collection thread. Several third party Java-packages that are likely to be used make use of multiple threads. How can this model coexist with the WarehousePG backend in the same process?</p><h4 id="solution" tabindex="-1"><a id="topic35"></a>Solution <a class="header-anchor" href="#solution" aria-label="Permalink to &quot;&lt;a id=&quot;topic35&quot;&gt;&lt;/a&gt;Solution&quot;">​</a></h4><p>The solution is simple. PL/Java defines a special object called the <code>Backend.THREADLOCK</code>. When PL/Java is initialized, the backend immediately grabs this objects monitor (i.e. it will synchronize on this object). When the backend calls a Java function, the monitor is released and then immediately regained when the call returns. All calls from Java out to backend code are synchronized on the same lock. This ensures that only one thread at a time can call the backend from Java, and only at a time when the backend is awaiting the return of a Java function call.</p><h3 id="exception-handling-1" tabindex="-1"><a id="topic36"></a>Exception Handling <a class="header-anchor" href="#exception-handling-1" aria-label="Permalink to &quot;&lt;a id=&quot;topic36&quot;&gt;&lt;/a&gt;Exception Handling&quot;">​</a></h3><p>Java makes frequent use of try/catch/finally blocks. WarehousePG sometimes use an exception mechanism that calls <code>longjmp</code> to transfer control to a known state. Such a jump would normally effectively bypass the JVM.</p><h4 id="solution-1" tabindex="-1"><a id="topic37"></a>Solution <a class="header-anchor" href="#solution-1" aria-label="Permalink to &quot;&lt;a id=&quot;topic37&quot;&gt;&lt;/a&gt;Solution&quot;">​</a></h4><p>The backend now allows errors to be caught using the macros <code>PG_TRY/PG_CATCH</code>/<code>PG_END_TRY</code> and in the catch block, the error can be examined using the ErrorData structure. PL/Java implements a <code>java.sql.SQLException</code> subclass called <code>org.postgresql.pljava.ServerException</code>. The ErrorData can be retrieved and examined from that exception. A catch handler is allowed to issue a rollback to a savepoint. After a successful rollback, execution can continue.</p><h3 id="java-garbage-collector-versus-palloc-and-stack-allocation" tabindex="-1"><a id="topic38"></a>Java Garbage Collector Versus palloc() and Stack Allocation <a class="header-anchor" href="#java-garbage-collector-versus-palloc-and-stack-allocation" aria-label="Permalink to &quot;&lt;a id=&quot;topic38&quot;&gt;&lt;/a&gt;Java Garbage Collector Versus palloc\\(\\) and Stack Allocation&quot;">​</a></h3><p>Primitive types are always be passed by value. This includes the <code>String</code> type (this is a must since Java uses double byte characters). Complex types are often wrapped in Java objects and passed by reference. For example, a Java object can contain a pointer to a palloc&#39;ed or stack allocated memory and use native JNI calls to extract and manipulate data. Such data will become stale once a call has ended. Further attempts to access such data will at best give very unpredictable results but more likely cause a memory fault and a crash.</p><h4 id="solution-2" tabindex="-1"><a id="topic39"></a>Solution <a class="header-anchor" href="#solution-2" aria-label="Permalink to &quot;&lt;a id=&quot;topic39&quot;&gt;&lt;/a&gt;Solution&quot;">​</a></h4><p>The PL/Java contains code that ensures that stale pointers are cleared when the MemoryContext or stack where they were allocated goes out of scope. The Java wrapper objects might live on but any attempt to use them will result in a stale native handle exception.</p><h2 id="example" tabindex="-1"><a id="topic40"></a>Example <a class="header-anchor" href="#example" aria-label="Permalink to &quot;&lt;a id=&quot;topic40&quot;&gt;&lt;/a&gt;Example&quot;">​</a></h2><p>The following simple Java example creates a JAR file that contains a single method and runs the method.</p><blockquote><p><strong>Note</strong> The example requires Java SDK to compile the Java file.</p></blockquote><p>The following method returns a substring.</p><div class="language-pre vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">pre</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>public static String substring(String text, int beginIndex,</span></span>
<span class="line"><span>  int endIndex)</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>    return text.substring(beginIndex, endIndex);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Enter the java code in a text file <code>example.class</code>.</p><p>Contents of the file <code>manifest.txt</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Manifest-Version: 1.0</span></span>
<span class="line"><span>Main-Class: Example</span></span>
<span class="line"><span>Specification-Title: &quot;Example&quot;</span></span>
<span class="line"><span>Specification-Version: &quot;1.0&quot;</span></span>
<span class="line"><span>Created-By: 1.6.0_35-b10-428-11M3811</span></span>
<span class="line"><span>Build-Date: 01/20/2013 10:09 AM</span></span></code></pre></div><p>Compile the java code:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>javac *.java</span></span></code></pre></div><p>Create a JAR archive named analytics.jar that contains the class file and the manifest file MANIFEST file in the JAR.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>jar cfm analytics.jar manifest.txt *.class</span></span></code></pre></div><p>Upload the jar file to the WarehousePG coordinator host.</p><p>Run the <code>gpsync</code> utility to copy the jar file to the WarehousePG Java directory. Use the <code>-f</code> option to specify the file that contains a list of the coordinator and segment hosts.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gpsync -f gphosts_file analytics.jar </span></span>
<span class="line"><span>=:/usr/local/greenplum-db/lib/postgresql/java/</span></span></code></pre></div><p>Use the <code>gpconfig</code> utility to set the WarehousePG <code>pljava_classpath</code> server configuration parameter. The parameter lists the installed jar files.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gpconfig -c pljava_classpath -v &#39;analytics.jar&#39;</span></span></code></pre></div><p>Run the <code>gpstop</code> utility with the <code>-u</code> option to reload the configuration files.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gpstop -u</span></span></code></pre></div><p>From the <code>psql</code> command line, run the following command to show the installed jar files.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>show pljava_classpath</span></span></code></pre></div><p>The following SQL commands create a table and define a Java function to test the method in the jar file:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>create table temp (a varchar) distributed randomly; </span></span>
<span class="line"><span>insert into temp values (&#39;my string&#39;); </span></span>
<span class="line"><span>--Example function </span></span>
<span class="line"><span>create or replace function java_substring(varchar, int, int) </span></span>
<span class="line"><span>returns varchar as &#39;Example.substring&#39; language java; </span></span>
<span class="line"><span>--Example execution </span></span>
<span class="line"><span>select java_substring(a, 1, 5) from temp;</span></span></code></pre></div><p>You can place the contents in a file, <code>mysample.sql</code> and run the command from a <code>psql</code> command line:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; \\i mysample.sql</span></span></code></pre></div><p>The output is similar to this:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>java_substring</span></span>
<span class="line"><span>----------------</span></span>
<span class="line"><span> y st</span></span>
<span class="line"><span>(1 row)</span></span></code></pre></div><h2 id="references" tabindex="-1"><a id="topic41"></a>References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;&lt;a id=&quot;topic41&quot;&gt;&lt;/a&gt;References&quot;">​</a></h2><p>The PL/Java Github wiki page - <a href="https://github.com/tada/pljava/wiki" target="_blank" rel="noreferrer">https://github.com/tada/pljava/wiki</a>.</p><p>PL/Java 1.5.0 release - <a href="https://github.com/tada/pljava/tree/REL1_5_STABLE" target="_blank" rel="noreferrer">https://github.com/tada/pljava/tree/REL1_5_STABLE</a>.</p>`,179)]))}const g=e(i,[["render",o]]);export{u as __pageData,g as default};
